; This macro creates a stub for an ISR which does NOT pass it's own
; error code (adds a dummy errcode byte).
%macro ISR_NOERRCODE 2
  global isr%1
  isr%1:
    push 0x0            ; Push a dummy error code.
    push %2             ; Push the interrupt number.
    jmp isr_common_stub ; Go to our common handler code.
%endmacro

; This macro creates a stub for an ISR which passes it's own
; error code.
%macro ISR_ERRCODE 2
  global isr%1
  isr%1:
    push %2             ; Push the interrupt number
    jmp isr_common_stub
%endmacro

; Exceptions
ISR_NOERRCODE 0, 0x00
ISR_NOERRCODE 1, 0x01
ISR_NOERRCODE 2, 0x02
ISR_NOERRCODE 3, 0x03
ISR_NOERRCODE 4, 0x04
ISR_NOERRCODE 5, 0x05
ISR_NOERRCODE 6, 0x06
ISR_NOERRCODE 7, 0x07
ISR_ERRCODE   8, 0x08
ISR_NOERRCODE 9, 0x09
ISR_ERRCODE   10, 0x0A
ISR_ERRCODE   11, 0x0B
ISR_ERRCODE   12, 0x0C
ISR_ERRCODE   13, 0x0D
ISR_ERRCODE   14, 0x0E
ISR_NOERRCODE 15, 0x0F
ISR_NOERRCODE 16, 0x10
ISR_ERRCODE   17, 0x11
ISR_NOERRCODE 18, 0x12
ISR_NOERRCODE 19, 0x13
ISR_NOERRCODE 20, 0x14
ISR_ERRCODE   21, 0x15
ISR_NOERRCODE 22, 0x16
ISR_NOERRCODE 23, 0x17
ISR_NOERRCODE 24, 0x18
ISR_NOERRCODE 25, 0x19
ISR_NOERRCODE 26, 0x1A
ISR_NOERRCODE 27, 0x1B
ISR_NOERRCODE 28, 0x1C
ISR_NOERRCODE 29, 0x1D
ISR_NOERRCODE 30, 0x1E
ISR_NOERRCODE 31, 0x1F

; IRQs
ISR_NOERRCODE 32, 0x20
ISR_NOERRCODE 33, 0x21
ISR_NOERRCODE 34, 0x22
ISR_NOERRCODE 35, 0x23
ISR_NOERRCODE 36, 0x24
ISR_NOERRCODE 37, 0x25
ISR_NOERRCODE 38, 0x26
ISR_NOERRCODE 39, 0x27
ISR_NOERRCODE 40, 0x28
ISR_NOERRCODE 41, 0x29
ISR_NOERRCODE 42, 0x2A
ISR_NOERRCODE 43, 0x2B
ISR_NOERRCODE 44, 0x2C
ISR_NOERRCODE 45, 0x2D
ISR_NOERRCODE 46, 0x2E
ISR_NOERRCODE 47, 0x2F

ISR_NOERRCODE 48, 0x30
ISR_NOERRCODE 49, 0x31
ISR_NOERRCODE 50, 0x32
ISR_NOERRCODE 51, 0x33
ISR_NOERRCODE 52, 0x34
ISR_NOERRCODE 53, 0x35
ISR_NOERRCODE 54, 0x36
ISR_NOERRCODE 55, 0x37
ISR_NOERRCODE 56, 0x38
ISR_NOERRCODE 57, 0x39
ISR_NOERRCODE 58, 0x3A
ISR_NOERRCODE 59, 0x3B
ISR_NOERRCODE 60, 0x3C
ISR_NOERRCODE 61, 0x3D
ISR_NOERRCODE 62, 0x3E
ISR_NOERRCODE 63, 0x3F
ISR_NOERRCODE 64, 0x40
ISR_NOERRCODE 65, 0x41
ISR_NOERRCODE 66, 0x42
ISR_NOERRCODE 67, 0x43
ISR_NOERRCODE 68, 0x44
ISR_NOERRCODE 69, 0x45
ISR_NOERRCODE 70, 0x46
ISR_NOERRCODE 71, 0x47
ISR_NOERRCODE 72, 0x48
ISR_NOERRCODE 73, 0x49
ISR_NOERRCODE 74, 0x4A
ISR_NOERRCODE 75, 0x4B
ISR_NOERRCODE 76, 0x4C
ISR_NOERRCODE 77, 0x4D
ISR_NOERRCODE 78, 0x4E
ISR_NOERRCODE 79, 0x4F
ISR_NOERRCODE 80, 0x50
ISR_NOERRCODE 81, 0x51
ISR_NOERRCODE 82, 0x52
ISR_NOERRCODE 83, 0x53
ISR_NOERRCODE 84, 0x54
ISR_NOERRCODE 85, 0x55
ISR_NOERRCODE 86, 0x56
ISR_NOERRCODE 87, 0x57
ISR_NOERRCODE 88, 0x58
ISR_NOERRCODE 89, 0x59
ISR_NOERRCODE 90, 0x5A
ISR_NOERRCODE 91, 0x5B
ISR_NOERRCODE 92, 0x5C
ISR_NOERRCODE 93, 0x5D
ISR_NOERRCODE 94, 0x5E
ISR_NOERRCODE 95, 0x5F
ISR_NOERRCODE 96, 0x60
ISR_NOERRCODE 97, 0x61
ISR_NOERRCODE 98, 0x62
ISR_NOERRCODE 99, 0x63
ISR_NOERRCODE 100, 0x64
ISR_NOERRCODE 101, 0x65
ISR_NOERRCODE 102, 0x66
ISR_NOERRCODE 103, 0x67
ISR_NOERRCODE 104, 0x68
ISR_NOERRCODE 105, 0x69
ISR_NOERRCODE 106, 0x6A
ISR_NOERRCODE 107, 0x6B
ISR_NOERRCODE 108, 0x6C
ISR_NOERRCODE 109, 0x6D
ISR_NOERRCODE 110, 0x6E
ISR_NOERRCODE 111, 0x6F
ISR_NOERRCODE 112, 0x70
ISR_NOERRCODE 113, 0x71
ISR_NOERRCODE 114, 0x72
ISR_NOERRCODE 115, 0x73
ISR_NOERRCODE 116, 0x74
ISR_NOERRCODE 117, 0x75
ISR_NOERRCODE 118, 0x76
ISR_NOERRCODE 119, 0x77
ISR_NOERRCODE 120, 0x78
ISR_NOERRCODE 121, 0x79
ISR_NOERRCODE 122, 0x7A
ISR_NOERRCODE 123, 0x7B
ISR_NOERRCODE 124, 0x7C
ISR_NOERRCODE 125, 0x7D
ISR_NOERRCODE 126, 0x7E
ISR_NOERRCODE 127, 0x7F
ISR_NOERRCODE 128, 0x80
ISR_NOERRCODE 129, 0x81
ISR_NOERRCODE 130, 0x82
ISR_NOERRCODE 131, 0x83
ISR_NOERRCODE 132, 0x84
ISR_NOERRCODE 133, 0x85
ISR_NOERRCODE 134, 0x86
ISR_NOERRCODE 135, 0x87
ISR_NOERRCODE 136, 0x88
ISR_NOERRCODE 137, 0x89
ISR_NOERRCODE 138, 0x8A
ISR_NOERRCODE 139, 0x8B
ISR_NOERRCODE 140, 0x8C
ISR_NOERRCODE 141, 0x8D
ISR_NOERRCODE 142, 0x8E
ISR_NOERRCODE 143, 0x8F
ISR_NOERRCODE 144, 0x90
ISR_NOERRCODE 145, 0x91
ISR_NOERRCODE 146, 0x92
ISR_NOERRCODE 147, 0x93
ISR_NOERRCODE 148, 0x94
ISR_NOERRCODE 149, 0x95
ISR_NOERRCODE 150, 0x96
ISR_NOERRCODE 151, 0x97
ISR_NOERRCODE 152, 0x98
ISR_NOERRCODE 153, 0x99
ISR_NOERRCODE 154, 0x9A
ISR_NOERRCODE 155, 0x9B
ISR_NOERRCODE 156, 0x9C
ISR_NOERRCODE 157, 0x9D
ISR_NOERRCODE 158, 0x9E
ISR_NOERRCODE 159, 0x9F
ISR_NOERRCODE 160, 0xA0
ISR_NOERRCODE 161, 0xA1
ISR_NOERRCODE 162, 0xA2
ISR_NOERRCODE 163, 0xA3
ISR_NOERRCODE 164, 0xA4
ISR_NOERRCODE 165, 0xA5
ISR_NOERRCODE 166, 0xA6
ISR_NOERRCODE 167, 0xA7
ISR_NOERRCODE 168, 0xA8
ISR_NOERRCODE 169, 0xA9
ISR_NOERRCODE 170, 0xAA
ISR_NOERRCODE 171, 0xAB
ISR_NOERRCODE 172, 0xAC
ISR_NOERRCODE 173, 0xAD
ISR_NOERRCODE 174, 0xAE
ISR_NOERRCODE 175, 0xAF
ISR_NOERRCODE 176, 0xB0
ISR_NOERRCODE 177, 0xB1
ISR_NOERRCODE 178, 0xB2
ISR_NOERRCODE 179, 0xB3
ISR_NOERRCODE 180, 0xB4
ISR_NOERRCODE 181, 0xB5
ISR_NOERRCODE 182, 0xB6
ISR_NOERRCODE 183, 0xB7
ISR_NOERRCODE 184, 0xB8
ISR_NOERRCODE 185, 0xB9
ISR_NOERRCODE 186, 0xBA
ISR_NOERRCODE 187, 0xBB
ISR_NOERRCODE 188, 0xBC
ISR_NOERRCODE 189, 0xBD
ISR_NOERRCODE 190, 0xBE
ISR_NOERRCODE 191, 0xBF
ISR_NOERRCODE 192, 0xC0
ISR_NOERRCODE 193, 0xC1
ISR_NOERRCODE 194, 0xC2
ISR_NOERRCODE 195, 0xC3
ISR_NOERRCODE 196, 0xC4
ISR_NOERRCODE 197, 0xC5
ISR_NOERRCODE 198, 0xC6
ISR_NOERRCODE 199, 0xC7
ISR_NOERRCODE 200, 0xC8
ISR_NOERRCODE 201, 0xC9
ISR_NOERRCODE 202, 0xCA
ISR_NOERRCODE 203, 0xCB
ISR_NOERRCODE 204, 0xCC
ISR_NOERRCODE 205, 0xCD
ISR_NOERRCODE 206, 0xCE
ISR_NOERRCODE 207, 0xCF
ISR_NOERRCODE 208, 0xD0
ISR_NOERRCODE 209, 0xD1
ISR_NOERRCODE 210, 0xD2
ISR_NOERRCODE 211, 0xD3
ISR_NOERRCODE 212, 0xD4
ISR_NOERRCODE 213, 0xD5
ISR_NOERRCODE 214, 0xD6
ISR_NOERRCODE 215, 0xD7
ISR_NOERRCODE 216, 0xD8
ISR_NOERRCODE 217, 0xD9
ISR_NOERRCODE 218, 0xDA
ISR_NOERRCODE 219, 0xDB
ISR_NOERRCODE 220, 0xDC
ISR_NOERRCODE 221, 0xDD
ISR_NOERRCODE 222, 0xDE
ISR_NOERRCODE 223, 0xDF
ISR_NOERRCODE 224, 0xE0
ISR_NOERRCODE 225, 0xE1
ISR_NOERRCODE 226, 0xE2
ISR_NOERRCODE 227, 0xE3
ISR_NOERRCODE 228, 0xE4
ISR_NOERRCODE 229, 0xE5
ISR_NOERRCODE 230, 0xE6
ISR_NOERRCODE 231, 0xE7
ISR_NOERRCODE 232, 0xE8
ISR_NOERRCODE 233, 0xE9
ISR_NOERRCODE 234, 0xEA
ISR_NOERRCODE 235, 0xEB
ISR_NOERRCODE 236, 0xEC
ISR_NOERRCODE 237, 0xED
ISR_NOERRCODE 238, 0xEE
ISR_NOERRCODE 239, 0xEF
ISR_NOERRCODE 240, 0xF0
ISR_NOERRCODE 241, 0xF1
ISR_NOERRCODE 242, 0xF2
ISR_NOERRCODE 243, 0xF3
ISR_NOERRCODE 244, 0xF4
ISR_NOERRCODE 245, 0xF5
ISR_NOERRCODE 246, 0xF6
ISR_NOERRCODE 247, 0xF7
ISR_NOERRCODE 248, 0xF8
ISR_NOERRCODE 249, 0xF9
ISR_NOERRCODE 250, 0xFA
ISR_NOERRCODE 251, 0xFB
ISR_NOERRCODE 252, 0xFC
ISR_NOERRCODE 253, 0xFD
ISR_NOERRCODE 254, 0xFE
ISR_NOERRCODE 255, 0xFF

; In isr.c
extern isr_handler

; This is our common ISR stub. It saves the processor state, sets
; up for kernel mode segments, calls the C-level fault handler,
; and finally restores the stack frame.
isr_common_stub:
    push rax
    push rbx
    push rcx
    push rdx

    push rbp

    push rsi
    push rdi

    push r8
    push r9
    push r10
    push r11
    push r12
    push r13
    push r14
    push r15

    mov rdi, rsp

    call isr_handler

    pop r15
    pop r14
    pop r13
    pop r12
    pop r11
    pop r10
    pop r9
    pop r8

    pop rdi
    pop rsi

    pop rbp

    pop rdx
    pop rcx
    pop rbx
    pop rax

    add rsp, 16 ; Cleans up the pushed error code and pushed ISR number
    iretq